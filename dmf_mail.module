<?php

/**
 * @file
 * Anyrel Mail module.
 */

use Drupal\dmf_mail\Manager\MailManager;
use Symfony\Component\Mime\Email;

/**
 * Implements hook_mail().
 */
function dmf_mail_mail($key, &$message, $params) {
  if ($key !== MailManager::KEY || !isset($params['email'])) {
    return;
  }

  /** @var Email $email */
  $email = $params['email'];

  // Subject.
  $message['subject'] = $email->getSubject() ?? '';

  // From address - set both message property and header.
  // Using toString() to get "Name <email>" format.
  // @see \Drupal\Core\Mail\MailManager::mail()
  $from = $email->getFrom();
  if (!empty($from)) {
    $fromAddress = $from[0]->toString();
    $message['from'] = $fromAddress;
    $message['headers']['From'] = $fromAddress;
  }

  // Reply-To address - override the header set by MailManager to include name.
  // Use 'Reply-to' (lowercase 't') to match Drupal's header key.
  $replyTo = $email->getReplyTo();
  if (!empty($replyTo)) {
    $replyToAddress = $replyTo[0]->toString();
    $message['reply-to'] = $replyToAddress;
    $message['headers']['Reply-to'] = $replyToAddress;
  }

  // Get body content.
  $htmlBody = $email->getHtmlBody();
  $textBody = $email->getTextBody();

  // Provide plain text for Mime Mail compatibility.
  // Mime Mail looks for $params['plaintext'] to create multipart/alternative.
  if ($textBody !== null && $textBody !== '') {
    $message['params']['plaintext'] = $textBody;
  }

  // Set the primary body.
  // For HTML emails, set the html flag and Content-Type header.
  if ($htmlBody !== null && $htmlBody !== '') {
    $message['params']['html'] = TRUE;
    $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed';
    $message['body'][] = $htmlBody;
  } elseif ($textBody !== null && $textBody !== '') {
    $message['body'][] = $textBody;
  }

  // CC recipients - use toString() for "Name <email>" format.
  $cc = $email->getCc();
  if (!empty($cc)) {
    $message['headers']['Cc'] = implode(', ', array_map(fn($addr) => $addr->toString(), $cc));
  }

  // BCC recipients - use toString() for "Name <email>" format.
  $bcc = $email->getBcc();
  if (!empty($bcc)) {
    $message['headers']['Bcc'] = implode(', ', array_map(fn($addr) => $addr->toString(), $bcc));
  }
}
